#!/bin/bash
set -euo pipefail

echo "🚀 Starting LDaCA Application for BinderHub..."

# Ensure data directories exist and have proper permissions
sudo mkdir -p /app/ldaca_web_app/backend/data/user_root
sudo chown -R jovyan:jovyan /app/ldaca_web_app/backend/data
sudo chmod -R 755 /app/ldaca_web_app/backend/data

# Initialize database if it doesn't exist
if [ ! -f /app/ldaca_web_app/backend/data/users.db ]; then
    echo "📊 Initializing database..."
    cd /app/ldaca_web_app/backend
    PYTHONPATH=/app /app/.venv/bin/python init_db.py
fi

echo "🌐 Starting LDaCA services..."

# Start supervisor as the jovyan user
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
